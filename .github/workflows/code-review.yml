name: Code Review

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  review:
    runs-on: ubuntu-latest
    name: Automated Code Review
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
      
      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
      
      - name: Review code changes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BLOCK_THRESHOLD: "critical:0.8,high:0.95"
          REVIEW_THRESHOLD: "high:0.7"
        run: |
          # Get the diff between base and head
          git diff origin/${{ github.base_ref }}..HEAD --name-only --diff-filter=d | grep '\.py$' > /tmp/changed_files.txt || true
          
          if [ ! -s /tmp/changed_files.txt ]; then
            echo "‚úÖ No Python files changed in this PR"
            echo "{\"status\": \"no_changes\", \"files\": []}" > /tmp/review_results.json
            exit 0
          fi
          
          echo "üìã Python files changed:"
          cat /tmp/changed_files.txt
          
          # Initialize review outputs
          > /tmp/review_results.md
          echo "## Code Review Results" >> /tmp/review_results.md
          echo "" >> /tmp/review_results.md
          echo "{\"reviews\": [" > /tmp/review_results.json
          
          failed=0
          first=true
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "### üìÑ Reviewing: \`$file\`" >> /tmp/review_results.md
              echo "" >> /tmp/review_results.md
              
              # Differentiate tool errors from security findings
              if code-review review "$file" --format json --block-threshold "$BLOCK_THRESHOLD" > /tmp/file_review.json 2>/tmp/file_review.err; then
                echo "‚úÖ Review complete" >> /tmp/review_results.md
                # Append to JSON array
                if [ "$first" = true ]; then
                  first=false
                else
                  echo "," >> /tmp/review_results.json
                fi
                cat /tmp/file_review.json >> /tmp/review_results.json
              else
                echo "‚ùó Tool review failed for $file" >> /tmp/review_results.md
                cat /tmp/file_review.err >> /tmp/review_results.md
                # Don't block merge on tool failure, only on security findings
                echo "Tool error encountered but not blocking merge" >> /tmp/review_results.md
              fi
              echo "" >> /tmp/review_results.md
            fi
          done < /tmp/changed_files.txt
          
          echo "]}" >> /tmp/review_results.json
          cat /tmp/review_results.md
          exit $failed
      
      - name: Upload audit JSON for governance
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: security-audit-${{ github.run_id }}
          path: /tmp/review_results.json
          retention-days: 30
      
      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = '/tmp/review_results.md';
            
            if (fs.existsSync(path)) {
              const body = fs.readFileSync(path, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body || '‚úÖ Code review completed successfully!'
              });
            }
      
      - name: Build Docker image for scanning
        run: |
          docker build -t frankie-review:latest .
      
      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frankie-review:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Generate Trivy SBOM
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'frankie-review:latest'
          format: 'cyclonedx'
          output: 'sbom.json'
      
      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-container'
      
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v6
        with:
          name: sbom-report-${{ github.run_id }}
          path: sbom.json
          retention-days: 90
      
      - name: Fail if critical issues
        if: failure()
        run: |
          echo "‚ùå Code review found critical issues"
          exit 1

